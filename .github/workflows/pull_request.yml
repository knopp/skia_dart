name: Pull Request

on:
  pull_request:
    branches: [master]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            config: mac_arm64_graphite_metal
          - os: windows-latest
            config: win_x64_graphite_d3d11
          - os: ubuntu-latest
            config: linux_x64_graphite_gl

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          submodules: recursive

      - name: Install dependencies
        working-directory: packages/skia_dart
        run: ../../flutter_zero/bin/dart pub get

      - name: Check skia_dart hash
        working-directory: packages/skia_dart
        run: ../../flutter_zero/bin/dart tool/build_tool.dart check-skia-hash

      - name: Read skia_dart hash
        id: read-hash
        shell: bash
        run: |
          HASH=$(cat packages/skia_dart/skia_dart_hash)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Check if release already exists
        id: check-release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HASH="${{ steps.read-hash.outputs.hash }}"
          TAG="skia_dart_${HASH}"
          if gh release view "$TAG" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "Release $TAG already exists, skipping build"
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG does not exist, proceeding with build"
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux' && steps.check-release.outputs.release_exists == 'false'
        run: sudo apt-get update && sudo apt-get install -y libfontconfig1-dev

      - name: Install EGL + Mesa (software) (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libegl1 \
            libegl-dev \
            libgl1-mesa-dev \
            libgles2-mesa-dev \
            libgl1-mesa-dri \
            libgbm-dev \
            mesa-utils \
            mesa-utils-extra

      - name: Force software OpenGL (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "LIBGL_ALWAYS_SOFTWARE=1" >> $GITHUB_ENV
          echo "MESA_LOADER_DRIVER_OVERRIDE=llvmpipe" >> $GITHUB_ENV
          echo "EGL_PLATFORM=surfaceless" >> $GITHUB_ENV

      - name: Select clang as default compiler (Linux)
        if: runner.os == 'Linux' && steps.check-release.outputs.release_exists == 'false'
        run: |
          sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang 100
          sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++ 100
          sudo update-alternatives --set cc /usr/bin/clang
          sudo update-alternatives --set c++ /usr/bin/clang++

      - name: Fetch Skia dependencies
        if: steps.check-release.outputs.release_exists == 'false'
        working-directory: skia
        run: python3 tools/git-sync-deps

      - name: Generate GN files
        if: steps.check-release.outputs.release_exists == 'false'
        working-directory: packages/skia_dart
        run: ../../flutter_zero/bin/dart tool/build_tool.dart gen --build-config=${{ matrix.config }}

      - name: Print args.gn
        if: steps.check-release.outputs.release_exists == 'false'
        working-directory: out/${{ matrix.config }}
        run: cat args.gn

      - name: Build Skia wrapper
        if: steps.check-release.outputs.release_exists == 'false'
        working-directory: out/${{ matrix.config }}
        run: ninja skia_dart

      - name: Run tests
        working-directory: packages/skia_dart
        run: ../../flutter_zero/bin/dart test
